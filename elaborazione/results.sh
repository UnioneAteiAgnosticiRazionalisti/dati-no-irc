#!/bin/bash

DB=aa_irc2025.db

DD=" AND DATODUBBIO=''"

show_by_region() {
    ANNO=$1
    echo "Non avvalentisi per regione, anno $ANNO, scuole pubbliche"

    echo "SELECT ANNOSCOLASTICO, REGIONE, SUM(NUMEROSTUDENTI), SUM(STUDENTINONAVV), ROUND(SUM(STUDENTINONAVV)*100.0/SUM(NUMEROSTUDENTI), 2) AS PERCNONAVV FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO $DD GROUP BY ANNOSCOLASTICO, REGIONE ORDER BY PERCNONAVV DESC" | sqlite3 -column -header $DB
}

show_by_district() {
    ANNO=$1
    echo "Non avvalentisi per provincia, anno $ANNO, scuole pubbliche"

    echo "SELECT ANNOSCOLASTICO, PROVINCIA, SUM(NUMEROSTUDENTI), SUM(STUDENTINONAVV), ROUND(SUM(STUDENTINONAVV)*100.0/SUM(NUMEROSTUDENTI), 2) AS PERCNONAVV FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO $DD GROUP BY ANNOSCOLASTICO, PROVINCIA ORDER BY PERCNONAVV DESC" | sqlite3 -column -header $DB
}

show_by_city() {
    ANNO=$1
    echo "Non avvalentisi per comune capolouogo, anno $ANNO, scuole pubbliche"

    echo "SELECT ANNOSCOLASTICO, DESCRIZIONECOMUNE, SUM(NUMEROSTUDENTI), SUM(STUDENTINONAVV), ROUND(SUM(STUDENTINONAVV)*100.0/SUM(NUMEROSTUDENTI), 2) AS PERCNONAVV FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO AND DESCRIZIONECOMUNE = PROVINCIA $DD GROUP BY ANNOSCOLASTICO, DESCRIZIONECOMUNE ORDER BY PERCNONAVV DESC" | sqlite3 -column -header $DB
}

show_by_major_city() {
    ANNO=$1
    SOGLIA=$2
    echo "Non avvalentisi per comune con piÃ¹ di $SOGLIA abitanti, anno $ANNO, scuole pubbliche"

    echo "SELECT ANNOSCOLASTICO, DESCRIZIONECOMUNE, SUM(NUMEROSTUDENTI), SUM(STUDENTINONAVV), ROUND(SUM(STUDENTINONAVV)*100.0/SUM(NUMEROSTUDENTI), 2) AS PERCNONAVV FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO AND NUMEROABITANTI >= $SOGLIA $DD GROUP BY ANNOSCOLASTICO, DESCRIZIONECOMUNE ORDER BY PERCNONAVV DESC" | sqlite3 -column -header $DB
}

show_by_city_town() {
    ANNO=$1
    TOWN="$2"
    echo "Non avvalentisi, anno $ANNO, nel comune di $TOWN, scuole pubbliche"

    echo "SELECT ANNOSCOLASTICO, DESCRIZIONECOMUNE, SUM(NUMEROSTUDENTI), SUM(STUDENTINONAVV), ROUND(SUM(STUDENTINONAVV)*100.0/SUM(NUMEROSTUDENTI), 2) AS PERCNONAVV FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO AND DESCRIZIONECOMUNE LIKE '$TOWN' $DD GROUP BY ANNOSCOLASTICO, DESCRIZIONECOMUNE ORDER BY PERCNONAVV DESC" | sqlite3 -column -header $DB
}


show_by_schoolkind() {
    ANNO=$1
    echo "Non avvalentisi per tipologia di scuola, anno $ANNO, scuole pubbliche"
    echo "SELECT ANNOSCOLASTICO, DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA AS TIPOSCUOLA, SUM(NUMEROSTUDENTI), SUM(STUDENTINONAVV), ROUND(SUM(STUDENTINONAVV)*100.0/SUM(NUMEROSTUDENTI), 2) AS PERCNONAVV FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO $DD GROUP BY ANNOSCOLASTICO, DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA ORDER BY PERCNONAVV DESC" | sqlite3 -column -header $DB
}

show_top_thirty() {
    ANNO=$1
    echo "Top thirty, anno $ANNO, scuole pubbliche (su csv)"
    echo "SELECT CODICESCUOLA, DENOMINAZIONESCUOLA, DESCRIZIONECOMUNE, PROVINCIA, DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA AS TIPOSCUOLA, NUMEROSTUDENTI, STUDENTIIRC, STUDENTINONAVV, ROUND(STUDENTINONAVV*100.0/NUMEROSTUDENTI, 2) AS PERCNONAVV, DATODUBBIO FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO $DD ORDER BY PERCNONAVV DESC LIMIT 30" | sqlite3 -csv -header $DB > top1000_$ANNO.csv

    echo "Top thirty, anno $ANNO, scuole pubbliche"
    echo "SELECT CODICESCUOLA, DENOMINAZIONESCUOLA, DESCRIZIONECOMUNE, PROVINCIA, DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA AS TIPOSCUOLA, NUMEROSTUDENTI, STUDENTIIRC, STUDENTINONAVV, ROUND(STUDENTINONAVV*100.0/NUMEROSTUDENTI, 2) AS PERCNONAVV, DATODUBBIO FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO $DD ORDER BY PERCNONAVV DESC LIMIT 30" | sqlite3 -column -header $DB

}

show_top_ten_district() {
    ANNO=$1
    PROVINCIA=$2
    echo "Top ten, anno $ANNO, scuole pubbliche, provincia di $PROVINCIA"
    echo "SELECT CODICESCUOLA, DENOMINAZIONESCUOLA, DESCRIZIONECOMUNE, DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA AS TIPOSCUOLA, NUMEROSTUDENTI, STUDENTINONAVV, ROUND(STUDENTINONAVV*100.0/NUMEROSTUDENTI, 2) AS PERCNONAVV FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO  AND PROVINCIA ='$PROVINCIA' $DD ORDER BY PERCNONAVV DESC LIMIT 10" | sqlite3 -column -header $DB
}

show_city() {
    ANNO=$1
    COMUNE=$2
    echo "Classifica completa, anno $ANNO, scuole pubbliche, comune di $COMUNE"
    echo "SELECT CODICESCUOLA, DENOMINAZIONESCUOLA, DESCRIZIONECOMUNE, DESCRIZIONETIPOLOGIAGRADOISTRUZIONESCUOLA AS TIPOSCUOLA, NUMEROSTUDENTI, STUDENTINONAVV, ROUND(STUDENTINONAVV*100.0/NUMEROSTUDENTI, 2) AS PERCNONAVV FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' AND ANNOSCOLASTICO = $ANNO  AND DESCRIZIONECOMUNE ='$COMUNE' $DD ORDER BY PERCNONAVV DESC" | sqlite3 -column -header $DB
}

###############



echo "Sintesi generale"
echo "SELECT ANNOSCOLASTICO, SUM(NUMEROSTUDENTI), SUM(STUDENTINONAVV), ROUND(SUM(STUDENTINONAVV)*100.0/SUM(NUMEROSTUDENTI), 2) AS PERCNONAVV FROM DATIRIASSUNTIVI WHERE AREAGEOGRAFICA IS NOT NULL AND TIPO = 'PUBBLICA' $DD GROUP BY ANNOSCOLASTICO ORDER BY ANNOSCOLASTICO ASC" | sqlite3 -column -header $DB

for YEAR in 202425; do
    echo -e "\n\n"
    show_by_region $YEAR
    echo -e "\n\n"
    show_by_district $YEAR
    echo -e "\n\n"
    show_by_schoolkind $YEAR
    echo -e "\n\n"
    show_top_thirty $YEAR
    echo -e "\n\n"
    show_by_city $YEAR
    echo -e "\n\n"
    show_by_major_city $YEAR 25000
done
